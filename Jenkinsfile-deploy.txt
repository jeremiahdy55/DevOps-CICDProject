pipeline {
    agent any

    environment {
        DOCKER_USER   = 'jeremiahjava55'
        CLUSTER_NAME  = 'my-eks-cluster'
        AWS_REGION    = 'us-west-1'
        GIT_CREDENTIALS = 'github_credentials'
        REPO_URL = 'https://github.com/jeremiahdy55/DevOps-CICDProject.git'
    }

    stages {
        stage('Checkout') {
            steps {
                git credentialsId: "${env.GIT_CREDENTIALS}", url: "${env.REPO_URL}", branch: 'main'
            }
        }
        
        stage('Configure kubectl') {
            steps {
                sh '''
                    aws eks update-kubeconfig --name $CLUSTER_NAME --region $AWS_REGION
                    kubectl get nodes
                '''
            }
        }

        stage('Deploy Microservices to EKS') {
            matrix {
                axes {
                    axis {
                        name 'SERVICE'
                        values 'order-ms', 'delivery-ms', 'payment-ms', 'stock-ms'
                    }
                }

                stages {
                    stage('Apply Deployment') {
                        steps {
                            dir("${SERVICE}/k8s") {
                                sh "kubectl apply -f deployment.yaml"
                                sh "kubectl apply -f service.yaml"
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'Deployment to EKS successful!'
        }
        failure {
            echo 'Deployment to EKS failed.'
        }
    }
}
